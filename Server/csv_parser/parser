const csv = require('csv-parser')
const fs = require('fs')
const axios = require('axios');

const headers = ["src/lat","src/long",'dest/lat','dest/long',"src_contact/name","src_contact/phone","dst_contact/name","dst_contact/phone","express","company_id","deadline"]
exports.parse = async function(file_name) {
    var json = await csvToJson(file_name)
    for(var i =0; i < json.length;i++){
      var order = json[i]
      for(let key of Object.keys(order)){
        if (!headers.includes(key))
            console.log("the field : "+key+" is not exist in headers format :" + headers)
      }

        lat  = order['src/lat']
        delete order['src/lat']
        long = order['src/long']
        delete order['src/long']
        order['src'] = {"lat" : lat, "long" : long}
        order['src_address'] = "HaSharon St 21, Tel Aviv-Yafo, Israel"
        lat  = order['dest/lat']
        delete order['dest/lat']
        long = order['dest/long']
        delete order['dest/long']
        order['dest'] = {"lat" : lat, "long" : long}
        order['dest_address'] = "Hartuv St 14, Tel Aviv-Yafo, Israel"
        name_contact  = order['src_contact/name']
        delete order['src_contact/name']
        phone_contact = order['src_contact/phone']
        delete order['src_contact/phone']
        order['src_contact'] = {"name" : name_contact, "phone" : phone_contact}
        
        name_contact  = order['dst_contact/name']
        delete order['dst_contact/name']
        phone_contact = order['dst_contact/phone']
        delete order['dst_contact/phone']
        order['dst_contact'] = {"name" : name_contact, "phone" : phone_contact}
        order["express"] == true
        order['status'] = "pending"
        order['Vehicle_type'] = "car,van,bike,scooter"
    }

    return json

}

function csvToJson(file_name){
  var results = [];
    return new Promise((resolve, reject) => {
        fs.createReadStream(file_name)
      .pipe(csv())
      .on('data', (data) => results.push(data))
      .on('end', () => {
        resolve(results)
        });
        })
}
async function convertLatLongToAddress(lat, long){
  url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${long}&key=AIzaSyCqcNNmxm-9YBysFypGjn8BUwdM3TUUegw`
  try {
    const response = await axios.get(url)
    //console.log(response.data);
    var results = response.data["results"][0]["formatted_address"]
    return results
  } catch (error) {
    console.log(error.response);
  }

}
